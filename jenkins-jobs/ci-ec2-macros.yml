- wrapper:
    name: ci-ec2-wrapper
    wrappers:
      - credentials-binding:
          - zip-file:
              credential-id: bae76e51-1edd-464c-9392-38014987ebd2
              variable: ANSIBLE_EC2_CREDENTIALS
          - text:
              credential-id: d476a914-f96c-4d91-902d-456b91f6e38e
              variable: AWS_SECRET_ACCESS_KEY
          - text:
              credential-id: e924c093-a9cd-47fd-9aae-3dfe615b4711
              variable: AWS_ACCESS_KEY_ID
      - workspace-cleanup:
          include:
            - "*.pem"

# ===================================================================
# ===================================================================
- trigger:
    name: ci-ec2-single-node-latest-trigger
    triggers:
      #- timed: '@daily'
      - build-result:
          combine: True
          groups:
            - jobs:
                - build-automation-repo-2.6-testing
                - build-automation-repo-2.7-testing
              results:
                - success

- trigger:
    name: ci-ec2-single-node-stable-trigger
    triggers:
      #- timed: '@daily'
      - build-result:
          combine: True
          groups:
            - jobs:
                - build-automation-repo-2.6-testing
                - build-automation-repo-2.7-testing
              results:
                - success

- trigger:
    name: ci-ec2-single-node-upgrade-trigger
    triggers:
      - build-result:
          groups:
            - jobs:
              - ci-ec2-single-node-stable-trigger

# ===================================================================
# ===================================================================
- publisher:
    name: ci-ec2-single-node-latest-publisher
    publishers:
      # Take the node offline so that another build doesn't pile on
      - groovy-postbuild: "manager.build.getBuiltOn().toComputer().setTemporarilyOffline(true)"
      - junit:
          results: "pulp-automation-ci/nosetests.xml"
      - archive:
          artifacts: "pulp-automation-ci/logs.log"

- publisher:
    name: ci-ec2-single-node-stable-publisher
    publishers:
      # Take the node offline so that another build doesn't pile on
      - groovy-postbuild: "manager.build.getBuiltOn().toComputer().setTemporarilyOffline(true)"
      - junit:
          results: "pulp-automation-ci/nosetests.xml"
      - archive:
          artifacts: "pulp-automation-ci/logs.log"
      - trigger-parameterized-builds:
          - project:
            - "pulp-single-node-upgrade-automation"
            trigger-with-no-params: True
            condition: ALWAYS

- publisher:
    name: ci-ec2-single-node-upgrade-publisher
    publishers:
      # Take the node offline so that another build doesn't pile on
      - groovy-postbuild: "manager.build.getBuiltOn().toComputer().setTemporarilyOffline(true)"
      - junit:
          results: "pulp-automation-ci/nosetests.xml"
      - archive:
          artifacts: "pulp-automation-ci/logs.log"
